---
title: "Supplement"
output:
  bookdown::pdf_document2:
    toc: FALSE
    keep_tex: TRUE

header-includes:
 - \usepackage{tikz}
 - \usetikzlibrary{positioning,arrows.meta, quotes, shapes}
---

```{r setup, include=F}
knitr::opts_chunk$set(echo=F, warning=F, message=F)#dev = "png", dev.args = list(type = "cairo-png")
 library("papaja")
library("bookdown")
library("rticles")
 library(here)
 library(tidyverse)
 library(brms)
library(tidybayes)
library(kableExtra)
library(viridis)
library(cowplot)
library(ggthemes)
#r_refs("r-references.bib", append=F)
theme_set(theme_bw())

model_location="code/models"
d <- read_csv(here("data", "processed_data.csv")) |> filter(status!="unusable") |> filter(include!="no")

```
# Heterogeneity analysis


```{r, echo=F}

all_true <- d |> filter(include %in% c("stats", "pred_int")) |> filter(!is.na(predInt)) |> filter(predInt) |> nrow()

all <- d |> filter(include %in% c("stats", "pred_int")) |> filter(!is.na(predInt)) |> nrow()

#of those with SMD predInts
all_orig  <- d |>filter(include=="stats") |> filter(!is.na(predInt_from_d)) |> nrow()
all_orig_true <- d |>filter(include=="stats") |> filter(!is.na(predInt_from_d)) |> filter(predInt) |> nrow()
all_d_true <- d |> filter(include=="stats") |> filter(!is.na(predInt_from_d)) |> filter(predInt_from_d) |> nrow()
all_tau <- d |> filter(include=="stats") |> filter(!is.na(predInt_from_d)) |> filter(predInt_with_tau) |> nrow()

```

The prediction interval and p-original values used for models and point estimates were done on the original scale where possible. However, to do heterogeneity analysis, our imputed value for tau is in SMD units, so we have to use SMD units for the original and replication values. This limits the number of applicable original-replication pairs. Prediction intervals are sensitive to whether only studies with SMD are included (different studies report differently and also vary in how close replications were) and whether the scale used was original or SMD (if the variances differed between original and replication). 

Of all studies where prediction intervals can be calculated, `r all_true`/`r all` (`r round(all_true/all*100)`%) of the original estimates had prediction intervals that included the replication effect size. For those where we have SMD, `r all_orig_true`/`r all_orig` (`r round(all_orig_true/all_orig*100)`%) of the original estimates had prediction intervals that included the replication effect size, when we use original units where possible.  Using SMD units, `r all_d_true`/`r all_orig` (`r round(all_d_true/all_orig*100)`%) of the original estimates had prediction intervals that included the replication effect size. Allowing for heterogeneity, with tau=.21, `r all_tau`/`r all_orig` (`r round(all_tau/all_orig*100)`%) of the original estimates are distributionally consistent. 


# Additional model results

Per our pre-registration, we ran a set of 6 models crossing 3 outcome measures (subjective replication score, whether the replication result was within the prediction interval of the original, and p-original on the hypothesis that both came from the same distribution) with 2 sets of predictors (with or without statistical predictors). These 6 models required 3 tiers of data: the subjective replication score without statistical predictors applies to all the data; the p_original and prediction interval models apply to the subset of data with numeric outcomes that can be compared; and the statistical predictor models need the smaller subset of data with p-values and original standardized effect size in particular. 

Due to low sample sizes and large numbers of predictors, even with regularizing priors, the coefficient estimates generally have a lot of uncertainty. 

## Sensitivity Analysis

As a check on whether our results were sensitive to the inclusion of pairs that were marginal in some way, we repeated the 6 models including only studies that were not marginal. For sensitivity analyses, we completely excluded some studies where the replication analysis was not the focal analysis of the original (ex. student chose a manipulation check as their primary analysis). We also excluded studies with extremely small or lop-sided sample sizes. 

For some studies that were included with some statistical outcomes in the main results, we downgraded them to experimental features only for sensitivity. Here, we felt the replication itself didn't have major problems and we felt confident in the subjective replication score reflecting holistically on the replication. However, there were some mismatches in the statistical reporting that meant we were not confident enough if your numeric calculations for the paper. Common mismatches were  where one reported a t-test and the other reported mean and SDs, and when degrees of freedom seemed inconsistent across replication and original (suggesting different groupings or levels of analysis). 

```{=latex}
\definecolor{bad}{HTML}{FFCCCB}
		\definecolor{meh}{HTML}{efefef}
			\definecolor{good}{HTML}{abcdff}
	\tikzset{
		mynode/.style={
			draw, rectangle, align=center, text width=4.5cm, scale=1, font=\small, inner sep=.5ex},
		arrow/.style={
		 very thick,->,>=stealth}
	}
	
\begin{figure}
	\begin{tikzpicture}[auto,
		node distance = 6mm and 30mm,
		every edge quotes/.append style = {font=\footnotesize, text=black, text centered}
		]
		\node (n1) [mynode, fill=good] {\textbf{112} pairs with statistical predictors};
		\node (n2) [mynode, below=of n1, fill=good]       {\textbf{24} additional pairs for p-original and prediction interval};
		\node (n3) [mynode,below=of n2, fill=good]    {\textbf{40} additional pairs for subjective replication};
		
		\node (n4) [mynode, fill=meh, right=of n1] {\textbf{82} pairs with statistical predictors};
		\node (n5) [mynode, below=of n4, fill=meh]       {\textbf{18} additional pairs for p-original and prediction interval};
		\node (n6) [mynode,below=of n5, fill=meh]    {\textbf{67} additional pairs for subjective replication only};
		\node (n7) [mynode,below=of n6, fill=bad]    {\textbf{9} pairs excluded};

		\begin{scope}[line width=1 pt, >=Stealth]
			\draw [->]   (n1.east) edge [pos=.8, "82"] (n4.west);
			\draw [->]   (n1.east) edge [pos=.8,"25", sloped] (n6.west);
			\draw [->]   (n1.east) edge [pos=.85,"5", sloped] (n7.west);
			
			\draw [->]   (n2.east) edge [pos=.8,"18"] (n5.west);
			\draw [->]   (n2.east) edge [pos=.6,"4", sloped] (n6.west);
			\draw [->]   (n2.east) edge [pos=.45,"2", sloped] (n7.west);
			
			\draw [->]   (n3.east) edge [pos=.2,"38"] (n6.west);
			\draw [->]   (n3.east) edge [pos=.5,"2", sloped] (n7.west);
			
		\end{scope}
	\end{tikzpicture}
	\caption{Diagram of what studies were downgraded or excluded for the sensitivity analysis.}
	\end{figure}

```



```{r forest, out.height="100%", fig.width=9, fig.height=12, fig.pos="ht", fig.cap="Forest plot of original and replication effect sizes. Original effect sizes are open dots, replication are closed dots. Coloring indicates subjective replication score, and p-original values are listed on the left side. "}

d |> 
  filter(target_d_calc < 5, rep_d_calc < 5) |>
  mutate(numpredInt=ifelse(predInt,1,0)) |> 
  ggplot(aes(y=reorder(target_lastauthor_year,target_d_calc, mean), color=as.factor(sub_rep)))+
    geom_vline(xintercept=0, linetype=3)+
  geom_point(aes(x=target_d_calc, shape="original"))+
  geom_point(aes(x=rep_d_calc, shape="replication"))+
  geom_segment(aes(x=target_d_calc, xend=rep_d_calc, y=target_lastauthor_year, yend=target_lastauthor_year))+
  scale_shape_manual(values=c("original"=21,"replication"=19), name=NULL)+
  coord_cartesian(xlim=c(-1.5,3.5))+
  geom_text(aes(x=-1.4, label=round(p_orig,3)), color="black", size=3, hjust=0, show.legend = F)+
  scale_color_viridis(discrete=T, direction = 1, 
                      name = "Subjective\nReplication\nSuccess\n")+theme_classic()+
  labs(x="Standardized Effect Size")+
  theme(axis.ticks.y=element_blank(), axis.title.y=element_blank())
```


```{r, eval=F}
do_draws <- function(model){
  draws <- model |> gather_draws(`b_[a-zA-Z_(): ]+`, regex=TRUE) |> 
    mutate(Term=str_sub(.variable, 3,-1) |> str_replace("M","_"), Estimate=.value) |>  filter(Term!="Intercept") |> 
    mutate(Term=factor(Term, levels=c("subfieldsocial", "subfieldother_psych", "subfieldnon_psych", "is_within", "single_vignette", "change_platform", "open_data", "open_mat", "stanford", "z_pub_year", "z_log_trials", "z_log_sample", "z_log_ratio_ss","z_log_p","z_target_d_calc"), labels=c("Social", "Other psych", "Non psych", "Within participants", "Single vignette", "Switch to online", "Open data", "Open materials", "Stanford", "Publication year", "Log trials", "Log original sample size", "Log rep/orig sample", "P-value", "Original effect size"))) 
}

tier1_subjective <- read_rds(here(model_location, "tier1_subjective.rds")) |> do_draws() |> mutate(type="All original-replication pairs") |> mutate(sens="All data")
tier2_porig <- read_rds(here(model_location, "tier2_porig.rds"))|> do_draws() |>  mutate(type="All original-replication pairs") |> mutate(sens="All data")
tier2_predint <- read_rds(here(model_location, "tier2_predint.rds"))|> do_draws() |>  mutate(type="All original-replication pairs") |> mutate(sens="All data")
tier3_subjective <- read_rds(here(model_location, "tier3_subjective.rds"))|> do_draws() |> mutate(type="Only pairs with full statistical info") |> mutate(sens="All data")
tier3_porig <- read_rds(here(model_location, "tier3_porig.rds"))|> do_draws() |>  mutate(type="Only pairs with full statistical info") |> mutate(sens="All data")
tier3_predint <- read_rds(here(model_location, "tier3_predint.rds"))|> do_draws() |>  mutate(type="Only pairs with full statistical info") |> mutate(sens="All data")

sens1_subjective <- read_rds(here(model_location, "sens_tier1_subjective.rds"))|> do_draws() |> mutate(type="All original-replication pairs") |> mutate(sens="Sensitivity test")
sens2_porig <- read_rds(here(model_location, "sens_tier2_porig.rds"))|> do_draws() |> mutate(type="All original-replication pairs")|> mutate(sens="Sensitivity test")
sens2_predint <- read_rds(here(model_location, "sens_tier2_predint.rds"))|> do_draws() |> mutate(type="All original-replication pairs")|> mutate(sens="Sensitivity test")
sens3_subjective <- read_rds(here(model_location, "sens_tier3_subjective.rds"))|> do_draws()|> mutate(type="Only pairs with full statistical info")|> mutate(sens="Sensitivity test")
sens3_porig <- read_rds(here(model_location, "sens_tier3_porig.rds"))|> do_draws()|> mutate(type="Only pairs with full statistical info")|> mutate(sens="Sensitivity test")
sens3_predint <- read_rds(here(model_location, "sens_tier3_predint.rds"))|> do_draws()|> mutate(type="Only pairs with full statistical info")|> mutate(sens="Sensitivity test")

subjective <- tier1_subjective |> union(tier3_subjective) |> union(sens1_subjective) |> union(sens3_subjective) |> mutate(OR=exp(Estimate))
porig <- tier2_porig |> union(tier3_porig) |> union(sens2_porig) |> union(sens3_porig)
predint <- tier2_predint |> union(tier3_predint) |> union(sens2_predint) |> union(sens3_predint) |> mutate(OR=exp(Estimate))
```


```{r}
do_estimates <- function(model){
  summary(model)$fixed |> as_tibble(rownames="var") |> select(var, Estimate, lower=`l-95% CI`, upper=`u-95% CI`) |> filter(!str_detect(var, "Intercept")) |> 
    mutate(var=str_replace(var, "M","_"),
           Term=factor(var, levels=c("subfieldsocial", "subfieldother_psych", "subfieldnon_psych", "is_within", "single_vignette", "change_platform", "open_data", "open_mat", "stanford", "z_pub_year", "z_log_trials", "z_log_sample", "z_log_ratio_ss","z_log_p","z_target_d_calc"), labels=c("Social psych", "Other psych", "Non psych", "Within participants", "Single vignette", "Switch to online", "Open data", "Open materials", "Stanford", "Publication year", "Log trials", "Log original sample size", "Log rep/orig sample", "P-value", "Original effect size"))) |> 
        mutate(est=str_c(round(Estimate,2)), 
               range=str_c("[", round(lower,2),", ", round(upper,2),"]")) |> 
    select(Term, est, range)
  
}
do_estimates_OR <- function(model){
  summary(model)$fixed |> as_tibble(rownames="var") |> select(var, Estimate, lower=`l-95% CI`, upper=`u-95% CI`) |> filter(!str_detect(var, "Intercept")) |> 
    mutate(var=str_replace(var, "M","_"),
           Term=factor(var, levels=c("subfieldsocial", "subfieldother_psych", "subfieldnon_psych", "is_within", "single_vignette", "change_platform", "open_data", "open_mat", "stanford", "z_pub_year", "z_log_trials", "z_log_sample", "z_log_ratio_ss","z_log_p","z_target_d_calc"), labels=c("Social psych", "Other psych", "Non psych", "Within participants", "Single vignette", "Switch to online", "Open data", "Open materials", "Stanford", "Publication year", "Log trials", "Log original sample size", "Log rep/orig sample", "P-value", "Original effect size"))) |> 
        mutate(OR=exp(Estimate),
               lower=exp(lower),
               upper=exp(upper),
               est=str_c(round(OR,2)), 
               range=str_c("[", round(lower,2),", ", round(upper,2),"]")) |> 
    select(Term, est, range)
  
}
```

```{r}

tier1_subjective <- read_rds(here(model_location, "tier1_subjective.rds")) |> do_estimates_OR() |> mutate(type="All pairs") 
tier3_subjective <- read_rds(here(model_location, "tier3_subjective.rds"))|> do_estimates_OR() |> mutate(type="Full stats")


sens1_subjective <- read_rds(here(model_location, "sens_tier1_subjective.rds"))|> do_estimates_OR() |> mutate(type="All pairs: Sensitivity")
sens3_subjective <- read_rds(here(model_location, "sens_tier3_subjective.rds"))|> do_estimates_OR()|> mutate(type="Full stats: Sensitivity")

subjective <- tier1_subjective |> union(tier3_subjective) |> union(sens1_subjective) |> union(sens3_subjective) |> pivot_wider(id_cols=Term, names_from=type, values_from=c(est, range), values_fill="--") |> select(Term, "est_All pairs","range_All pairs", "est_Full stats", "range_Full stats",  "est_All pairs: Sensitivity" , "range_All pairs: Sensitivity", "est_Full stats: Sensitivity", "range_Full stats: Sensitivity") |> arrange(desc(`est_Full stats`))
```

```{r}

tier2_predint <- read_rds(here(model_location, "tier2_predint.rds")) |> do_estimates_OR() |> mutate(type="All pairs") 
tier3_predint <- read_rds(here(model_location, "tier3_predint.rds"))|> do_estimates_OR() |> mutate(type="Full stats")


sens2_predint <- read_rds(here(model_location, "sens_tier2_predint.rds"))|> do_estimates_OR() |> mutate(type="All pairs: Sensitivity")
sens3_predint <- read_rds(here(model_location, "sens_tier3_predint.rds"))|> do_estimates_OR()|> mutate(type="Full stats: Sensitivity")

predint <- tier2_predint |> union(tier3_predint) |> union(sens2_predint) |> union(sens3_predint) |> pivot_wider(id_cols=Term, names_from=type, values_from=c(est, range), values_fill="--") |> select(Term, "est_All pairs","range_All pairs", "est_Full stats", "range_Full stats",  "est_All pairs: Sensitivity" , "range_All pairs: Sensitivity", "est_Full stats: Sensitivity", "range_Full stats: Sensitivity") |> arrange(desc(`est_Full stats`))
```

```{r}

tier2_porig <- read_rds(here(model_location, "tier2_porig.rds")) |> do_estimates() |> mutate(type="All pairs") 
tier3_porig <- read_rds(here(model_location, "tier3_porig.rds"))|> do_estimates() |> mutate(type="Full stats")


sens2_porig <- read_rds(here(model_location, "sens_tier2_porig.rds"))|> do_estimates() |> mutate(type="All pairs: Sensitivity")
sens3_porig <- read_rds(here(model_location, "sens_tier3_porig.rds"))|> do_estimates()|> mutate(type="Full stats: Sensitivity")

porig<- tier2_porig |> union(tier3_porig) |> union(sens2_porig) |> union(sens3_porig) |> pivot_wider(id_cols=Term, names_from=type, values_from=c(est, range), values_fill="--") |> select(Term, "est_All pairs","range_All pairs", "est_Full stats", "range_Full stats",  "est_All pairs: Sensitivity" , "range_All pairs: Sensitivity", "est_Full stats: Sensitivity", "range_Full stats: Sensitivity") |> arrange(desc(`est_Full stats`))
```

```{r}
knitr::kable(subjective, col.names=NULL, align='rrlrlrlrl',position="!h", caption="Odds ratios and 95\\% CrI from ordinal models predicting subjective replication scores. All pairs indicates that all pairs used, regardless of whether they had full statistical information; Full stats indicates that only pairs with full statistical information was used. Sensitivity indicates that it was a sensitivity test.", booktabs=T, linesep="") |> kable_styling() |>  
  add_header_above(c(" " = 1, "N=176" = 2, "N=112" = 2, "N=167" = 2, "N=82"=2)) |> 
 add_header_above(c(" " = 1, " " = 2, " " = 2, "Sensitivity" = 2, "Sensitivity"=2)) |> add_header_above(c(" " = 1, "All pairs" = 2, "Full stats" = 2, "All pairs" = 2, "Full stats"=2))
  

```

```{r}
knitr::kable(predint, col.names=NULL, align='rrlrlrlrl',position="!h", caption="Odds ratios and 95\\% CrI from logistic models predicting whether the prediction interval of the original effect contained the replication effect. All pairs indicates that all pairs with calculable prediction intervals were used, regardless of whether they had full statistical information; Full stats indicates that only data with full statistical information was used. Sensitivity indicates that it was a sensitivity test.", booktabs=T, linesep="") |> kable_styling() |>  
  add_header_above(c(" " = 1, "N=136" = 2, "N=112" = 2, "N=100" = 2, "N=82"=2)) |> 
 add_header_above(c(" " = 1, " " = 2, " " = 2, "Sensitivity" = 2, "Sensitivity"=2)) |> add_header_above(c(" " = 1, "All pairs" = 2, "Full stats" = 2, "All pairs" = 2, "Full stats"=2))
  

```

```{r}
knitr::kable(predint, col.names=NULL, align='rrlrlrlrl',position="!h", caption="Coefficients and 95\\% CrI from linear models predictiong the p-original value between the original and replicaiton effects. All pairs indicates that all pairs with calculable prediction intervals were used, regardless of whether they had full statistical information; Full stats indicates that only data with full statistical information was used. Sensitivity indicates that it was a sensitivity test.", booktabs=T, linesep="") |> kable_styling() |>  
  add_header_above(c(" " = 1, "N=136" = 2, "N=112" = 2, "N=100" = 2, "N=82"=2)) |> 
 add_header_above(c(" " = 1, " " = 2, " " = 2, "Sensitivity" = 2, "Sensitivity"=2)) |> add_header_above(c(" " = 1, "All pairs" = 2, "Full stats" = 2, "All pairs" = 2, "Full stats"=2))
  

```

