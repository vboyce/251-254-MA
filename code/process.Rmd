---
title: "251 MA"
output:
  html_document: 
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=F, message=F)
knitr::opts_chunk$set(dev = "png", dev.args = list(type = "cairo-png"))
options(knitr.table.format = "html")
knitr::opts_chunk$set(echo = F)
library(tidyverse)
library(viridis)
library(Replicate)
library(metafor)
library(esc)
library(here)
library(brms)
library(rstan)
library(googledrive)
library(glmnet)
library(tidybayes)
library(ggstance)
library("lattice")
library(reshape2)
library(ggrepel)
library(ggthemes)

rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

theme_set(theme_bw())

model_location="code/models"
```


# Pull data

Download

```{r, eval=F}
f <- googledrive::as_dribble("https://docs.google.com/spreadsheets/d/1UT6KLRujn6iEQ_s01_4yNfFYqc7hAWTpB-t9mdDp0O8/edit#gid=0")
googledrive::drive_download(f, path=here("data","raw_data.xlsx"), overwrite=T)

```

Read in cache.

```{r}
d <- readxl::read_xlsx(here("data","raw_data.xlsx"), 
                       sheet="aligned data", skip=1) |> 
  select(target_lastauthor_year, sensitivity, include,
         status, academic_year, subfield, target_year, stanford_internal, 
         open_data, open_materials, target_on_turk, replication_on_turk, 
         within_between, single_vignette, repeated_measure,
         target_N, target_raw_stat, same_dir, replication_N,
         replication_raw_stat, replicated_instructor_code, replicated_report_code,
         adjudicated_replication_code)

```

Counts.

```{r}

d |> tally()
d |> group_by(status) |> tally()

d |> filter(!status %in% c("missing", "non-experiment", "reproduction")) |> tally()

d |> group_by(include) |> tally()

```
We have maybe as many as 177 at least for some analyses. 

Descriptions: 

- "done" -- fully coded, can be used for whatever is specified in other column 
- "ES_direction" -- we don't have the direction coded 
- "ask" -- might be salvageable, but I have questions about coding
- "unusable" -- got as far as I can, and it does not have complete descriptives
- "missing" -- student didn't finish or we don't have write-up
- "non-experiment" -- student replicated something that was not an experiment
- "reproduction" -- student did a reproduction and not replication 

```{r}
d_val <- d |> filter(!status %in% c("missing", "non-experiment", "reproduction"))
```

# Parsing

We parse out values from the raw stats. 

```{r}
source(here("code","helper","parse_stats.R"))
```


```{r}
test <- d_val |> 
  mutate(target_raw_stat=gsub(" ","",target_raw_stat),
         target=pmap(list(target_raw_stat, within_between,target_N), do_parsing),
         replication_raw_stat=gsub(" ","",replication_raw_stat),
         rep=pmap(list(replication_raw_stat, within_between,replication_N), do_parsing)) |> 
  unnest(cols=c(target, rep), names_sep="_") |> 
  rowwise()
```

## what didn't parse

Check that nothing that has a stat input and doesn't get an ES out. 

```{r}

test |> filter(is.na(target_ES)) |> filter(!is.na(target_raw_stat)) |> select(target_lastauthor_year, target_raw_stat)

test |> filter(is.na(rep_ES)) |> filter(!is.na(replication_raw_stat)) |> select(target_lastauthor_year, replication_raw_stat)

```

# PredInt and P_orig

```{r}
source(here("code","helper","stats.R"))
```

Compute prediction intervals and p_orig.

```{r}

d_es <-  test |> 
  mutate(target_d_calc=abs(target_d_calc),
         target_ES=abs(target_ES),
         rep_d_calc=case_when(
           same_dir=="yes" ~ abs(rep_d_calc),
           same_dir=="no" ~-abs(rep_d_calc),
           T ~ as.numeric(NA)
         ),
         rep_ES=case_when(
           same_dir=="yes" ~ abs(rep_ES),
           same_dir=="no" ~-abs(rep_ES),
           T ~ as.numeric(NA)
         ))

d_es_predInt <- d_es |> 
  rowwise() |> 
  mutate(predInt = do_pred_int(target_ES, target_SE, rep_ES, rep_SE),
         p_orig = do_p_orig(target_ES, target_SE, rep_ES, rep_SE),
         sub_rep = do_subjective_rep(replicated_instructor_code, 
                                     replicated_report_code, 
                                     adjudicated_replication_code))
```

# viz SMD

First pass plots. 

```{r}
d_es_predInt |> ggplot(aes(x=target_d_calc, y=rep_d_calc, color=p_orig))+
  geom_point()+
  coord_cartesian(xlim=c(0,2), ylim=c(-1,3))+
  geom_abline(slope=1, intercept=0)+
  geom_hline(yintercept=0)+
  scale_color_viridis(discrete=F, direction=1)+
  labs(color="p_orig", x="Original SMD", y="Replication SMD")

d_es_predInt |> ggplot(aes(x=target_d_calc, y=rep_d_calc, color=predInt))+
  geom_point()+
  coord_cartesian(xlim=c(0,2), ylim=c(-1,3))+
  geom_abline(slope=1, intercept=0)+
  geom_hline(yintercept=0)+
  scale_color_viridis(discrete=T, direction=-1)+
  labs(color="rep in predInt", x="Original SMD", y="Replication SMD")
```

Working more on the visualization with subjective rep status.

```{r}
d_es_predInt |> 
  filter(target_d_calc < 5, rep_d_calc < 5) |>
  ggplot(aes(x=target_d_calc, y=rep_d_calc, color=sub_rep))+
 
  geom_abline(slope=1, intercept=0, lty = 2)+
  geom_smooth(method = "lm") + 
   geom_point(size=2.5) +
  geom_hline(yintercept = 0, lty = 2)+
  scale_color_viridis(discrete=F, direction = 1, 
                      name = "Subjective\nReplication\nSuccess\n")+
  labs(color="subrep", x="Original SMD", y="Replication SMD") + 
  theme(legend.position = "right")

ggsave(here("plots/smd.pdf"))

```


```{r}
d_es_predInt |> ggplot(aes(x=target_ES, 
                           xmin=target_ES-target_SE*1.96,
                           xmax=target_ES+target_SE*1.96, 
                           y=rep_ES,
                           ymin=rep_ES-rep_SE*1.96,
                           ymax=rep_ES+rep_SE*1.96,
                           color=p_orig))+
  geom_linerange(alpha=.5)+
  geom_linerangeh(alpha=.5)+
  geom_point()+
  coord_cartesian(xlim=c(-1,12), ylim=c(-1,12))+
  geom_abline(slope=1, intercept=0)+
  geom_hline(yintercept=0)+
  scale_color_viridis(discrete=F, direction=-1)+
  labs(color="p_orig", x="Original ES", y="Replication ES")

d_es_predInt |> ggplot(aes(x=target_ES, 
                           xmin=target_ES-target_SE*1.96,
                           xmax=target_ES+target_SE*1.96, 
                           y=rep_ES,
                           ymin=rep_ES-rep_SE*1.96,
                           ymax=rep_ES+rep_SE*1.96,
                           color=p_orig))+
  geom_linerange(alpha=.5)+
  geom_linerangeh(alpha=.5)+
  geom_point()+
  coord_cartesian(xlim=c(-1,2), ylim=c(-1,2))+
  geom_abline(slope=1, intercept=0)+
  geom_hline(yintercept=0)+
  scale_color_viridis(discrete=F, direction=-1)+
  labs(color="p_orig", x="Original ES", y="Replication ES")

d_es_predInt |> ggplot(aes(x=target_ES, 
                           xmin=target_ES-target_SE*1.96,
                           xmax=target_ES+target_SE*1.96, 
                           y=rep_ES,
                           ymin=rep_ES-rep_SE*1.96,
                           ymax=rep_ES+rep_SE*1.96,
                           color=predInt))+
  geom_linerange(alpha=.5)+
  geom_linerangeh(alpha=.5)+
  geom_point()+
  coord_cartesian(xlim=c(-1,12), ylim=c(-1,12))+
  geom_abline(slope=1, intercept=0)+
  geom_hline(yintercept=0)+
  scale_color_viridis(discrete=T, direction=-1)+
  labs(color="predInt", x="Original ES", y="Replication ES")

d_es_predInt |> ggplot(aes(x=target_ES, 
                           xmin=target_ES-target_SE*1.96,
                           xmax=target_ES+target_SE*1.96, 
                           y=rep_ES,
                           ymin=rep_ES-rep_SE*1.96,
                           ymax=rep_ES+rep_SE*1.96,
                           color=predInt))+
  geom_linerange(alpha=.5)+
  geom_linerangeh(alpha=.5)+
  geom_point()+
  coord_cartesian(xlim=c(-1,2), ylim=c(-1,2))+
  geom_abline(slope=1, intercept=0)+
  geom_hline(yintercept=0)+
  scale_color_viridis(discrete=T, direction=-1)+
  labs(color="predInt", x="Original ES", y="Replication ES")

d_es_predInt |> ggplot(aes(x=target_ES, 
                           xmin=target_ES-target_SE*1.96,
                           xmax=target_ES+target_SE*1.96, 
                           y=rep_ES,
                           ymin=rep_ES-rep_SE*1.96,
                           ymax=rep_ES+rep_SE*1.96,
                           color=sub_rep))+
  geom_linerange(alpha=.5)+
  geom_linerangeh(alpha=.5)+
  geom_point()+
  coord_cartesian(xlim=c(-1,12), ylim=c(-1,12))+
  geom_abline(slope=1, intercept=0)+
  geom_hline(yintercept=0)+
  scale_color_viridis(discrete=F, direction=-1)+
  labs(color="sub rep", x="Original ES", y="Replication ES")

d_es_predInt |> ggplot(aes(x=target_ES, 
                           xmin=target_ES-target_SE*1.96,
                           xmax=target_ES+target_SE*1.96, 
                           y=rep_ES,
                           ymin=rep_ES-rep_SE*1.96,
                           ymax=rep_ES+rep_SE*1.96,
                           color=sub_rep))+
  geom_linerange(alpha=.5)+
  geom_linerangeh(alpha=.5)+
  geom_point()+
  coord_cartesian(xlim=c(-1,2), ylim=c(-1,2))+
  geom_abline(slope=1, intercept=0)+
  geom_hline(yintercept=0)+
  scale_color_viridis(discrete=F, direction=-1)+
  labs(color="sub rep", x="Original ES", y="Replication ES")
```

# How much missing data?

Note, it may seem weird that we're missing d and SE for many more replications than we are p values. This is because we can't get d_calc if we don't have a filled in value for same direction (but we have p value and unsigned d_calc). 

```{r, message=T}
message("total rows")
d_es_predInt |> filter(!status %in% c("missing", "non-experiment", "reproduction")) |> nrow()

d_check_nas <- d_es_predInt |> filter(!status %in% c("missing", "non-experiment", "reproduction")) |> ungroup() |>
  select(include, target_lastauthor_year, status, academic_year, subfield, target_year,
         stanford_internal,open_data, open_materials, target_on_turk,
         replication_on_turk, within_between, single_vignette, repeated_measure,
         target_N, replication_N,
         target_p_calc, target_d_calc, rep_p_calc, rep_d_calc,
         predInt, p_orig, sub_rep) 

message("number of rows for subjective w/ demographic/experimental")

message("expected")
d_check_nas |> filter(include %in% c("stats", "pred_int", "exp")) |> nrow()
message("actual")

d_check_nas |> filter(include %in% c("stats", "pred_int", "exp")) |>
  select(target_lastauthor_year, status, academic_year,  target_year,
         sub_rep, subfield,
         stanford_internal,open_data, open_materials, target_on_turk,
         replication_on_turk, within_between, single_vignette, repeated_measure,
         target_N, replication_N) |> filter(across(everything(), ~!is.na(.))) |> nrow()

message("number of rows for predInt/p_orig w/ demographic/experimental")
message("expected")
d_check_nas |> filter(include %in% c("stats", "pred_int")) |> nrow()
message("actual")


d_check_nas |> filter(include %in% c("stats", "pred_int")) |>  select(target_lastauthor_year, status, academic_year, target_year,
                                                                      sub_rep, subfield,
                                                                      stanford_internal,open_data, open_materials, target_on_turk,
                                                                      replication_on_turk, within_between, single_vignette, repeated_measure,
                                                                      target_N, replication_N, predInt, p_orig) |> 
  # filter(if_any(everything(), ~is.na(.)))
  filter(across(everything(), ~!is.na(.))) |> nrow()

message("number of complete rows for full analysis")

message("expected")
d_check_nas |> filter(include %in% c("stats")) |> nrow()
message("actual")


d_check_nas |> filter(include %in% c("stats")) |> filter(across(everything(), ~!is.na(.))) |> nrow()
```

# how close subrep

```{r}

 d_es_predInt |> filter(include %in% c("stats", "pred_int", "exp")) |> mutate(match=replicated_instructor_code==replicated_report_code) |> ungroup() |>  mutate(abs_dif=abs(replicated_instructor_code-replicated_report_code)) |> summarize(foo=mean(abs_dif))



```

# code vars for models

```{r}
d_for_model <- d_es_predInt |> 
  ungroup() |> 
  mutate(pub_year= target_year-mean(target_year),
         log_p =log(target_p_calc),
         log_sample =log(target_N),
         log_ratio_ss = log(replication_N/target_N),
         change_platform=ifelse(replication_on_turk==target_on_turk,0,1),
         #this codes 1 if the original was in person, but replication turk/prolific,
         # 0 if they were both on turk/prolific or both in-person (rare, but happens a few times)
         open_data=ifelse(open_data=="yes", 1,0),
         open_mat=ifelse(open_materials=="yes", 1,0),
         stanford=ifelse(stanford_internal=="yes", 1,0),
         is_within=case_when(
           within_between=="within" ~ 1,
           within_between=="mixed" ~ 1,
           within_between=="between" ~ 0),
         log_trials=log(repeated_measure),
         predInt=as.numeric(predInt)) |> 
  select(include, target_lastauthor_year, academic_year, subfield, 
         pub_year, log_p, log_sample, log_ratio_ss, change_platform, target_d_calc,
         stanford, open_data, open_mat, 
         is_within, single_vignette, log_trials, 
         predInt, p_orig, sub_rep)

summary(d_for_model)

```

## z-score

```{r}

z_data <- d_for_model |> 
  mutate(across(c("pub_year","log_p", "log_sample", "log_ratio_ss","target_d_calc", "log_trials"), ~scale(.)[,1], .names="z_{.col}"))

back_convert <- d_for_model |> 
  summarize(across(c("pub_year","log_p", "log_sample", "log_ratio_ss","target_d_calc", "log_trials"), ~mean(., na.rm=T), .names="mean_{.col}"),
            across(c("pub_year","log_p", "log_sample", "log_ratio_ss","target_d_calc", "log_trials"), ~sd(.,na.rm=T), .names="sd_{.col}"))


```

## check z-score

```{r}
# z_data |>
#   mutate(check_pub=pub_year - z_pub_year*back_convert$sd_pub_year+back_convert$mean_pub_year) |> 
#   filter(check_pub > .00001)
```

## tier 1 data
```{r}
data_tier1 <- z_data |> filter(include %in% c("stats", "exp", "pred_int")) |>
  mutate(sub_rep=sub_rep*4+1) |>  #remap to 1-5 scale
  select(academic_year, sub_rep, 
         z_pub_year, subfield, open_data, open_mat, stanford, change_platform, z_log_ratio_ss, is_within, single_vignette, z_log_sample, z_log_trials) 

```

## tier 2 data
```{r}
data_tier2 <- z_data |> filter(include %in% c("stats", "pred_int")) |>
  select(academic_year, sub_rep, 
         p_orig, predInt,
         z_pub_year, subfield, open_data, open_mat, stanford, change_platform, z_log_ratio_ss, is_within, single_vignette, z_log_sample, z_log_trials) 
```

## tier 3 data
```{r}
data_tier3 <- z_data |>  filter(include %in% c("stats")) |>
  select(academic_year, sub_rep, 
         p_orig, predInt,
         z_target_d_calc, z_log_p, 
         z_pub_year, subfield, open_data, open_mat, stanford, change_platform, z_log_ratio_ss, is_within, single_vignette, z_log_sample, z_log_trials) 
```

# Pre-reg'd Models

Note: tier 2 and 3 models are subject to change as a few more studies might in fact have useable stats & some of the effect size extraction might be incorrect. 

```{r}

priors <- c(set_prior("horseshoe(3)", class="b"),
            set_prior("normal(0,.5)", class="sd"),
            set_prior("lkj(1)", class="cor"))
```

```{r, eval=T}
tier1_subjective <- brm(sub_rep ~ z_pub_year + subfield + open_data +  open_mat + stanford + change_platform + 
                          z_log_ratio_ss + is_within + single_vignette + z_log_sample + z_log_trials + 
                          (z_pub_year + subfield + open_data +  open_mat + stanford + change_platform + 
                             z_log_ratio_ss + is_within + single_vignette + z_log_sample + z_log_trials | academic_year),
                        family="cumulative", # runs on 1-5 data
                        data=data_tier1,
                        file=here(model_location, "tier1_subjective"),
                        prior=priors, 
                        control=list(adapt_delta=.99),
                        backend="cmdstanr"
)
```

```{r}
tier1_subjective |> 
gather_draws(`b_[a-zA-Z_(): ]+`, regex=TRUE) |> mutate(Term=str_sub(.variable, 3,-1) |> str_replace("M","_"), Estimate=.value) |> 
  ggplot(aes(y = reorder(Term, Estimate, mean), x = Estimate)) + geom_vline(xintercept=0)+
  stat_pointinterval(color="#440154")+labs(y="", x="Estimate, 66%, 95% CrI predicting subjective replication score")+theme(axis.text=element_text(size=11))

ggsave(here("plots/tier1.pdf"))

```


```{r, eval=T}
tier2_predint <- brm(predInt ~ z_pub_year + subfield + open_data +  open_mat + stanford + change_platform + 
                       z_log_ratio_ss + is_within + single_vignette + z_log_sample + z_log_trials + 
                       (z_pub_year + subfield + open_data +  open_mat + stanford + change_platform + 
                          z_log_ratio_ss + is_within + single_vignette + z_log_sample + z_log_trials | academic_year),
                     family="bernoulli",
                     data=data_tier2,
                     file=here(model_location, "tier2_predint"),
                     prior=priors, 
                     control=list(adapt_delta=.99),
                     backend="cmdstanr")
```

```{r}
tier2_predint |> 
gather_draws(`b_[a-zA-Z_(): ]+`, regex=TRUE) |> mutate(Term=str_sub(.variable, 3,-1) |> str_replace("M","_"), Estimate=.value) |> filter(Term!="Intercept") |> 
  ggplot(aes(y = reorder(Term, Estimate, mean), x = Estimate)) + geom_vline(xintercept=0)+
  stat_pointinterval(color="#440154")+labs(y="", x="Estimate, 66%, 95% CrI predicting replication in prediction interval")+theme(axis.text=element_text(size=11))

ggsave(here("plots/tier2_pred.pdf"))

```

```{r, eval=T}
tier2_porig <- brm(p_orig ~ z_pub_year + subfield + open_data +  open_mat + stanford + change_platform + 
                     z_log_ratio_ss + is_within + single_vignette + z_log_sample + z_log_trials + 
                     (z_pub_year + subfield + open_data +  open_mat + stanford + change_platform + 
                        z_log_ratio_ss + is_within + single_vignette + z_log_sample + z_log_trials | academic_year),
                   data=data_tier2,
                   file=here(model_location, "tier2_porig"),
                   prior=priors, 
                   control=list(adapt_delta=.99),
                   backend="cmdstanr")
```

```{r}
tier2_porig |> 
gather_draws(`b_[a-zA-Z_(): ]+`, regex=TRUE) |> mutate(Term=str_sub(.variable, 3,-1) |> str_replace("M","_"), Estimate=.value) |> filter(Term!="Intercept") |> 
  ggplot(aes(y = reorder(Term, Estimate, mean), x = Estimate)) + geom_vline(xintercept=0)+
  stat_pointinterval(color="#440154")+labs(y="", x="Estimate, 66%, 95% CrI predicting p_original")+theme(axis.text=element_text(size=11))

ggsave(here("plots/porig.pdf"))

```
```{r, eval=T}
tier3_subjective <- brm(sub_rep ~ z_pub_year + subfield + open_data +  open_mat + stanford + change_platform + 
                          z_log_ratio_ss + is_within + single_vignette + z_log_sample + z_log_trials + 
                          z_target_d_calc + z_log_p+ 
                          (z_pub_year + subfield + open_data +  open_mat + stanford + change_platform + 
                             z_log_ratio_ss + is_within + single_vignette + z_log_sample + z_log_trials + 
                             z_target_d_calc + z_log_p| academic_year),
                        family="cumulative",
                        data=data_tier3 |> mutate(sub_rep=sub_rep*4+1),
                        file=here(model_location, "tier3_subjective"),
                        prior=priors, 
                        control=list(adapt_delta=.99),
                        backend="cmdstanr")
```

```{r}
tier3_subjective |> 
gather_draws(`b_[a-zA-Z_(): ]+`, regex=TRUE) |> mutate(Term=str_sub(.variable, 3,-1) |> str_replace("M","_"), Estimate=.value) |> 
  ggplot(aes(y = reorder(Term, Estimate, mean), x = Estimate)) + geom_vline(xintercept=0)+
  stat_pointinterval(color="#440154")+labs(y="", x="Estimate, 66%, 95% CrI predicting subjective replication with stats predictors")+theme(axis.text=element_text(size=11))

ggsave(here("plots/tier3sub.pdf"))
```

```{r, eval=T}
tier3_predint <- brm(predInt ~ z_pub_year + subfield + open_data +  open_mat + stanford + change_platform + 
                       z_log_ratio_ss + is_within + single_vignette + z_log_sample + z_log_trials + 
                       z_target_d_calc + z_log_p+ 
                       (z_pub_year + subfield + open_data +  open_mat + stanford + change_platform + 
                          z_log_ratio_ss + is_within + single_vignette + z_log_sample + z_log_trials + 
                          z_target_d_calc + z_log_p| academic_year),
                     family="bernoulli",
                     data=data_tier3,
                     file=here(model_location, "tier3_predint"),
                     prior=priors, 
                     control=list(adapt_delta=.99),
                     backend="cmdstanr")
```

```{r}
tier3_predint |> 
gather_draws(`b_[a-zA-Z_(): ]+`, regex=TRUE) |> mutate(Term=str_sub(.variable, 3,-1) |> str_replace("M","_"), Estimate=.value) |> filter(Term!="Intercept") |> 
  ggplot(aes(y = reorder(Term, Estimate, mean), x = Estimate)) + geom_vline(xintercept=0)+
  stat_pointinterval(color="#440154")+labs(y="", x="Estimate, 66%, 95% CrI predicting prediction interval with stats predictors")+theme(axis.text=element_text(size=11))

ggsave(here("plots/tier3pred.pdf"))

```

```{r, eval=T}
tier3_porig <- brm(p_orig ~ z_pub_year + subfield + open_data +  open_mat + stanford + change_platform + 
                     z_log_ratio_ss + is_within + single_vignette + z_log_sample + z_log_trials + 
                     z_target_d_calc + z_log_p+ 
                     (z_pub_year + subfield + open_data +  open_mat + stanford + change_platform + 
                        z_log_ratio_ss + is_within + single_vignette + z_log_sample + z_log_trials + 
                        z_target_d_calc + z_log_p| academic_year),
                   data=data_tier3,
                   file=here(model_location, "tier3_porig"),
                   prior=priors, 
                   control=list(adapt_delta=.99),
                   backend="cmdstanr"
)
```

```{r}
tier3_porig |> 
gather_draws(`b_[a-zA-Z_(): ]+`, regex=TRUE) |> mutate(Term=str_sub(.variable, 3,-1) |> str_replace("M","_"), Estimate=.value) |> filter(Term!="Intercept") |> 
  ggplot(aes(y = reorder(Term, Estimate, mean), x = Estimate)) + geom_vline(xintercept=0)+
  stat_pointinterval(color="#440154")+labs(y="", x="Estimate, 66%, 95% CrI predicting p_original with stats predictors")+theme(axis.text=element_text(size=11))

ggsave(here("plots/tier3porig.pdf"))

```

## Sensitivity analysis TODO

# Exploratory working

## correlation

```{r}
dat <- data_tier1 |> mutate(is.cog=ifelse(subfield=="cognitive", 1,0),
                            is.soc=ifelse(subfield=="social", 1,0),
                            is.other=ifelse(subfield=="other-psych", 1,0),
                            is.non=ifelse(subfield=="non-psych",1,0)) |> 
  select(is.cog, is.soc, is.other, is.non,stanford, z_pub_year, open_data, open_mat,  change_platform, 
         z_log_ratio_ss, z_log_sample, single_vignette, z_log_trials, is_within, ) 

corr_mat <- round(cor(dat),2) 

# Install and load reshape2 package


# reduce the size of correlation matrix
melted_corr_mat <-melt(corr_mat)
# head(melted_corr_mat)

# plotting the correlation heatmap
ggplot(data = melted_corr_mat, aes(x=Var1, y=Var2,
                                   fill=value)) + #scale_fill_viridis()+
  scale_fill_gradient2(low="#440154",high="#FDE725FF")+
  geom_tile(alpha=.7)+theme(axis.text.x = element_text(angle = 40, vjust = 1, hjust=1))+geom_text(aes(label=value), size=3)+
  labs(x="", y="", fill="Correlation")

ggsave(here("plots/corr.pdf"))


#corr_mat |> as_tibble(rownames="value2") |> pivot_longer(cols=!value2, names_to="value1", values_to = "corr") |> arrange(corr) |> filter(value2 <value1) |> View()

#corr_mat |> as_tibble(rownames="value2") |> pivot_longer(cols=!value2, names_to="value1", values_to = "corr") |> arrange(desc(corr)) |> filter(value2 <value1)

```

including tier 3 predictors

```{r}
dat <- data_tier3 |> mutate(is.cog=ifelse(subfield=="cognitive", 1,0),
                            is.soc=ifelse(subfield=="social", 1,0),
                            is.other=ifelse(subfield=="other-psych", 1,0),
                            is.non=ifelse(subfield=="non-psych",1,0)) |> 
  select(is.cog, is.soc, is.other, is.non,stanford, z_pub_year, open_data, open_mat,  change_platform, 
         z_log_ratio_ss, z_log_sample, single_vignette, z_log_trials, is_within, z_log_p, z_target_d_calc) 

corr_mat <- round(cor(dat),2) 

# Install and load reshape2 package


# reduce the size of correlation matrix
melted_corr_mat <-melt(corr_mat)
# head(melted_corr_mat)

# plotting the correlation heatmap
ggplot(data = melted_corr_mat, aes(x=Var1, y=Var2,
                                   fill=value)) + #scale_fill_viridis()+
  scale_fill_gradient2(low="#440154",high="#FDE725FF")+
  geom_tile(alpha=.7)+theme(axis.text.x = element_text(angle = 40, vjust = 1, hjust=1))+geom_text(aes(label=value), size=3)+
  labs(x="", y="", fill="Correlation")

#corr_mat |> as_tibble(rownames="value2") |> pivot_longer(cols=!value2, names_to="value1", values_to = "corr") |> arrange(corr) |> filter(value2 <value1) |> View()

#corr_mat |> as_tibble(rownames="value2") |> pivot_longer(cols=!value2, names_to="value1", values_to = "corr") |> arrange(desc(corr)) |> filter(value2 <value1)
ggsave(here("plots/corr_all.pdf"))

```




## Frequentist Lassoes

```{r}

boring_logistic <- glm(sub_rep ~ z_pub_year + subfield + open_data +  open_mat + stanford + change_platform + 
                         z_log_ratio_ss + is_within + single_vignette + z_log_sample + z_log_trials,
                       family=binomial, 
                       data=data_tier1 |> mutate(sub_rep=(sub_rep-1)/4),
                       
)
boring_logistic$coefficients |> as.tibble(rownames="coeff") |> mutate(odds=exp(value)) |> select(-value) |> filter(coeff!="(Intercept)") |> kable()

fun <- glm(sub_rep ~  open_data *  open_mat,
                       family=binomial, 
                       data=data_tier1 |> mutate(sub_rep=(sub_rep-1)/4),
                       
)
```

regularized tier 1 sub
```{r}
predictors <- data_tier1 |> mutate(social=ifelse(subfield=="social", 1,0),other_psych=ifelse(subfield=="other-psych",1,0), non_psych=ifelse(subfield=="non-psych", 1,0)) |> 
  select(z_pub_year, open_data, open_mat, stanford, change_platform, social, other_psych, non_psych, 
                                   z_log_ratio_ss, is_within, single_vignette, z_log_sample, z_log_trials) |> as.matrix()

yvals <- data_tier1 |> mutate(sub_rep=(sub_rep-1)/4) |> pull(sub_rep)
lasso_linear_1 <- cv.glmnet(predictors, yvals |> as.matrix(),       family="gaussian", alpha=1)

lasso_linear2 <- glmnet(predictors, yvals, 
                        family="gaussian", alpha=1)
```

```{r}

to_plot <- lasso_linear2$beta |> as.matrix() |> as.tibble(rownames="var") |> pivot_longer(!var) |> mutate(time=str_sub(name, 2,-1) |> as.numeric())


ggplot(to_plot, aes(x=time, y=value, color=var, label=var))+geom_line()+geom_label_repel(data=to_plot |> filter(time==70), min.segment.length = 100, nudge_x = 15, na.rm = TRUE)+
  scale_color_tableau("Classic 20")+
  labs(y="Coefficient", x="more regularized <-       Degree of regularization       -> less regularized        \nfew predictors <-                                                    -> many predictors   \n worse fit to data <-                                                    -> better fit to data        ")+
  coord_cartesian(xlim=c(0,90), ylim=c(-.2, .3))+theme(axis.text.x=element_blank(), axis.title=element_text(size=14), axis.ticks.x=element_blank(), legend.position="none")

ggsave(here("plots/tier1_lasso.pdf"))


```

regularized p_orig

```{r}
dat <- data_tier2 |> filter(!is.na(p_orig)) |>  mutate(social=ifelse(subfield=="social", 1,0),other_psych=ifelse(subfield=="other-psych",1,0), non_psych=ifelse(subfield=="non-psych", 1,0))
predictors <- dat |> select(z_pub_year, open_data, open_mat, stanford, 
                            change_platform, social, non_psych, other_psych,
                                   z_log_ratio_ss, is_within, single_vignette, z_log_sample, z_log_trials) |> as.matrix()

yvals <- dat|> pull(p_orig)


lasso_linear_porig <- glmnet(predictors, yvals, 
                        family="gaussian", alpha=1)

yvals <- dat |> pull(predInt)

lasso_linear_predint <- glmnet(predictors, yvals, 
                        family="binomial", alpha=1)
```

```{r}
to_plot <- lasso_linear_porig$beta |> as.matrix() |> as.tibble(rownames="var") |> pivot_longer(!var) |> mutate(time=str_sub(name, 2,-1) |> as.numeric())


ggplot(to_plot, aes(x=time, y=value, color=var, label=var))+geom_line()+geom_label_repel(data=to_plot |> filter(time==60), min.segment.length = 100, nudge_x = 20, na.rm = TRUE)+
    annotate("text", x=30, y=.15,label="Predicting p-original", color="black", size=5, hjust=1)+
theme(legend.position="none")+ scale_color_tableau("Classic 20")+
  coord_cartesian(xlim=c(0,90))+theme(axis.text.x=element_blank(), axis.title.x=element_blank(), axis.ticks.x=element_blank(), legend.position="none")

ggsave(here("plots/tier2_lasso_porig.pdf"))

```

```{r}
to_plot <- lasso_linear_predint$beta |> as.matrix() |> as.tibble(rownames="var") |> pivot_longer(!var) |> mutate(time=str_sub(name, 2,-1) |> as.numeric())


ggplot(to_plot, aes(x=time, y=value, color=var, label=var))+geom_line()+geom_label_repel(data=to_plot |> filter(time==55), min.segment.length = 100, nudge_x = 15, na.rm = TRUE)+
      annotate("text", x=30, y=1.3,label="Predicting prediction interval", color="black", size=5, hjust=1)+ 
theme(legend.position="none")+ scale_color_tableau("Classic 20")+
  coord_cartesian(xlim=c(0,80))+theme(axis.text.x=element_blank(), axis.title.x=element_blank(), axis.ticks.x=element_blank())

ggsave(here("plots/tier2_lasso_pred.pdf"))

```

Tier 3

```{r}
dat <- data_tier3 |> filter(!is.na(p_orig)) |>  mutate(social=ifelse(subfield=="social", 1,0),other_psych=ifelse(subfield=="other-psych",1,0), non_psych=ifelse(subfield=="non-psych", 1,0))
predictors <- dat |> select(z_pub_year, open_data, open_mat, stanford, 
                            change_platform, social, non_psych, other_psych,
                                   z_log_ratio_ss, is_within, single_vignette, z_log_sample, z_log_trials, z_target_d_calc, z_log_p) |> as.matrix()

yvals <- dat |> pull(sub_rep)
lasso_3sub <- glmnet(predictors, yvals, 
                        family="gaussian", alpha=1)
yvals <- dat|> pull(p_orig)


lasso_3porig <- glmnet(predictors, yvals, 
                        family="gaussian", alpha=1)

yvals <- dat |> pull(predInt)

lasso_3predint <- glmnet(predictors, yvals, 
                        family="binomial", alpha=1)
```

```{r}
to_plot <- lasso_3sub$beta |> as.matrix() |> as.tibble(rownames="var") |> pivot_longer(!var) |> mutate(time=str_sub(name, 2,-1) |> as.numeric())


ggplot(to_plot, aes(x=time, y=value, color=var, label=var))+geom_line()+geom_label_repel(data=to_plot |> filter(time==69), min.segment.length = 100, nudge_x = 15, na.rm = TRUE)+
      annotate("text", x=40, y=.25,label="Predicting subjective replication", color="black", size=5, hjust=1)+
theme(legend.position="none")+ scale_color_tableau("Classic 20")+
  coord_cartesian(xlim=c(0,90))+theme(axis.text.x=element_blank(), axis.title.x=element_blank(), axis.ticks.x=element_blank())

ggsave(here("plots/tier3_lasso_sub.pdf"))

```

```{r}
to_plot <- lasso_3predint$beta |> as.matrix() |> as.tibble(rownames="var") |> pivot_longer(!var) |> mutate(time=str_sub(name, 2,-1) |> as.numeric())


ggplot(to_plot, aes(x=time, y=value, color=var, label=var))+geom_line()+geom_label_repel(data=to_plot |> filter(time==60), min.segment.length = 100, nudge_x = 15, na.rm = TRUE)+ theme(legend.position="none")+ scale_color_tableau("Classic 20")+
      annotate("text", x=40, y=1.5,label="Predicting prediction interval", color="black", size=5, hjust=1)+
  
  coord_cartesian(xlim=c(0,90))+theme(axis.text.x=element_blank(), axis.title.x=element_blank(), axis.ticks.x=element_blank())

ggsave(here("plots/tier3_lasso_pred.pdf"))

```

```{r}
to_plot <- lasso_3porig$beta |> as.matrix() |> as.tibble(rownames="var") |> pivot_longer(!var) |> mutate(time=str_sub(name, 2,-1) |> as.numeric())


ggplot(to_plot, aes(x=time, y=value, color=var, label=var))+geom_line()+geom_label_repel(data=to_plot |> filter(time==61), min.segment.length = 100, nudge_x = 20, na.rm = TRUE)+
        annotate("text", x=30, y=.15,label="Predicting p-original", color="black", size=5, hjust=1)+

  theme(legend.position="none")+ scale_color_tableau("Classic 20")+
  coord_cartesian(xlim=c(0,90))+theme(axis.text.x=element_blank(), axis.title.x=element_blank(), axis.ticks.x=element_blank())

ggsave(here("plots/tier3_lasso_porig.pdf"))

```

## Correlations

```{r}
for_cor <- data_tier1 |> mutate(social=ifelse(subfield=="social", 1,0),other_psych=ifelse(subfield=="other-psych",1,0), non_psych=ifelse(subfield=="non-psych", 1,0)) 
sub_cor <- function(var, stat = "estimate") {
  if (stat == "estimate") {
    cor.test(for_cor$sub_rep, pull(for_cor, {{var}}))$estimate
  } else {
    cor.test(for_cor$sub_rep, pull(for_cor, {{var}}))$p.value
  }
}



preds <- c("z_pub_year", "open_data",  "open_mat", "stanford", "change_platform", 
           "z_log_ratio_ss", "is_within", "single_vignette", "z_log_sample", 
           "z_log_trials", "social", "other_psych", "non_psych")

cors <- tibble(preds = preds) |>
  mutate(r = sapply(preds, function(x) sub_cor(x, stat = "estimate")),
         p = sapply(preds, function(x) sub_cor(x, stat = "p"))) |> 
  mutate(Predictors=factor(preds, levels=c("social", "other_psych", "non_psych", "is_within", "single_vignette", "change_platform", "open_data", "open_mat", "stanford", "z_pub_year", "z_log_trials", "z_log_sample", "z_log_ratio_ss"), labels=c("Social", "Other psych", "Non psych", "Within subjects", "Single vignette", "Switch to online", "Open data", "Open materials", "Stanford", "Publication year", "Log trials", "Log original sample size", "Log rep/orig sample"))) |> arrange(Predictors) |> select(Predictors, r, p)

library(kableExtra)
knitr::kable(cors, digits = 3, align='rcc') |> kable_styling(full_width=F, htmltable_class = "lightable-classic-2", font_size=40) 
```



## Individual predictor - outcome correlations

### Sub_rep
```{r}
dat <- data_tier1 |> mutate(sub_rep=((sub_rep-1)/4) |> factor(levels=c("0","0.25", "0.5", "0.75", "1")))

ggplot(dat, aes(x=sub_rep, fill=sub_rep))+geom_bar(stat="count", position="dodge")+scale_fill_viridis(discrete=T)+theme(legend.position = "none", axis.text=element_text(size=14), axis.title=element_text(size=14))+labs(y="Count", x="Subjective Replication score")

ggsave(here("plots/score_all.pdf"))

dat |> mutate(subfield=factor(subfield, levels=c("cognitive", "social", "other-psych", "non-psych"), labels=c("Cognitive\npsychology", "Social\npsychology", "Other\npsychology", "Not\npsychology"))) |> ggplot(aes(x=subfield, fill=sub_rep))+geom_bar(stat="count", position="dodge")+scale_fill_viridis(discrete=T)+theme(axis.text=element_text(size=14), axis.title=element_text(size=14), axis.title.x=element_blank())+labs(y="Count")

ggsave(here("plots/subfield.pdf"))


dat |> mutate(open_mat=ifelse(open_mat, "Open materials", "No open materials"), open_data=ifelse(open_data, "Open data", "No open data")) |> ggplot( aes(x=open_data |> factor(), fill=sub_rep))+geom_bar(stat="count", position="dodge")+scale_fill_viridis(discrete=T)+facet_wrap(.~open_mat)+theme(axis.text=element_text(size=14), axis.title=element_text(size=14), axis.title.x=element_blank(), strip.text = element_text(size=14))+labs(y="Count")

ggsave(here("plots/openness.pdf"))


 # ggplot(dat, aes(x=ifelse(stanford, "Stanford affiliation", "No Stanford affiliation"), fill=sub_rep))+geom_bar(stat="count", position="dodge")+scale_fill_viridis(discrete=T)+theme( axis.text=element_text(size=11), axis.title.x=element_blank())
 # ggsave(here("plots/stanford.pdf"))

 
ggplot(dat, aes(x=ifelse(change_platform,"Switch to online","Same modality"), fill=sub_rep))+geom_bar(stat="count", position="dodge")+scale_fill_viridis(discrete=T)+theme(axis.text=element_text(size=14), axis.title=element_text(size=14), axis.title.x=element_blank())+labs(y="Count")

ggsave(here("plots/modality.pdf"))


ggplot(dat, aes(x=ifelse(is_within, "Within", "Between"), fill=sub_rep))+geom_bar(stat="count", position="dodge")+scale_fill_viridis(discrete=T)+theme(axis.text=element_text(size=14), axis.title=element_text(size=14), axis.title.x=element_blank())+labs(y="Count")

ggsave(here("plots/within.pdf"))

ggplot(dat, aes(x=ifelse(single_vignette, "Single vignette", "Multiple vignettes"), fill=sub_rep))+geom_bar(stat="count", position="dodge")+scale_fill_viridis(discrete=T)+theme(axis.text=element_text(size=14), axis.title=element_text(size=14), axis.title.x=element_blank())+labs(y="Count")

ggsave(here("plots/vignette.pdf"))

```

```{r}
# using d for model to get non-z-scored version
ggplot(d_for_model, aes(x=pub_year, y=sub_rep, color=sub_rep))+geom_jitter()+geom_smooth(method="lm")+scale_color_viridis()+theme( axis.text=element_text(size=11))

ggsave(here("plots/pubyear.pdf"))


ggplot(d_for_model, aes(x=log_ratio_ss, y=log_sample, color=sub_rep))+geom_point()+scale_color_viridis()+theme( axis.text=element_text(size=11))

ggsave(here("plots/ss_v_sample.pdf"))

ggplot(d_for_model, aes(x=log_ratio_ss, y=sub_rep, color=sub_rep))+geom_jitter()+geom_smooth(method="lm")+scale_color_viridis()+theme( axis.text=element_text(size=11))

ggsave(here("plots/ss_ratio.pdf"))

ggplot(d_for_model, aes(x=log_trials, y=log_sample, color=sub_rep))+geom_jitter()+geom_smooth(method="lm")+scale_color_viridis()+theme( axis.text=element_text(size=11))

ggsave(here("plots/sample_v_trials.pdf"))

ggplot(d_for_model, aes(x=log_trials+log_sample, y=sub_rep, color=sub_rep))+geom_jitter()+geom_smooth(method="lm")+scale_color_viridis()+theme( axis.text=element_text(size=11))+labs(x="Trials * Subjects (log scale)")

ggsave(here("plots/trial_sample.pdf"))


ggplot(d_for_model, aes(x=log_sample, y=sub_rep, color=sub_rep))+geom_jitter()+geom_smooth(method="lm")+scale_color_viridis()+theme( axis.text=element_text(size=11))

ggsave(here("plots/log_sample.pdf"))


ggplot(d_for_model, aes(x=log_trials, y=sub_rep, color=sub_rep))+geom_jitter()+geom_smooth(method="lm")+scale_color_viridis()+theme( axis.text=element_text(size=11))

ggsave(here("plots/log_trials.pdf"))


```

### Pred_int
Note: predInt may not be reliably calculated in some cases. Dealing with numbers is hard! 

```{r}
dat <- d_for_model |> filter(!is.na(predInt)) |>  mutate(predInt=predInt |> factor())

# d_for_model |> filter(!is.na(predInt)) |>  mutate(porig.num=ifelse(p_orig>.05, 1,0))|> summarize(pred=mean(predInt), por=mean(p_orig), pornum=mean(porig.num))

ggplot(dat, aes(x=predInt, fill=predInt))+geom_bar(stat="count", position="dodge")+scale_fill_viridis(discrete=T)

ggplot(dat, aes(x=subfield, fill=predInt))+geom_bar(stat="count", position="dodge")+scale_fill_viridis(discrete=T)

ggplot(dat, aes(x=open_data |> factor(), fill=predInt))+geom_bar(stat="count", position="dodge")+scale_fill_viridis(discrete=T)+facet_wrap(.~str_c("open_mat ",open_mat))

ggplot(dat, aes(x=factor(stanford), fill=predInt))+geom_bar(stat="count", position="dodge")+scale_fill_viridis(discrete=T)

ggplot(dat, aes(x=factor(change_platform), fill=predInt))+geom_bar(stat="count", position="dodge")+scale_fill_viridis(discrete=T)

ggplot(dat, aes(x=factor(is_within), fill=predInt))+geom_bar(stat="count", position="dodge")+scale_fill_viridis(discrete=T)

ggplot(dat, aes(x=factor(single_vignette), fill=predInt))+geom_bar(stat="count", position="dodge")+scale_fill_viridis(discrete=T)
```

```{r}
# using d for model to get non-z-scored version
dat <- d_for_model |> filter(!is.na(predInt))

ggplot(dat, aes(x=pub_year, y=predInt, color=predInt))+geom_jitter()+geom_smooth(method="lm")+scale_color_viridis()

ggplot(dat, aes(x=log_ratio_ss, y=log_sample, color=predInt))+geom_point()+scale_color_viridis()

ggplot(dat, aes(x=log_ratio_ss, y=predInt, color=predInt))+geom_jitter()+geom_smooth(method="lm")+scale_color_viridis()

ggplot(dat, aes(x=log_sample, y=predInt, color=predInt))+geom_jitter()+geom_smooth(method="lm")+scale_color_viridis()

ggplot(dat, aes(x=log_trials, y=predInt, color=predInt))+geom_jitter()+geom_smooth(method="lm")+scale_color_viridis()

```

### P_orig
Note: predInt may not be reliably calculated in some cases. Dealing with numbers is hard! 

```{r}
dat <- d_for_model |> filter(!is.na(p_orig)) |> mutate(p_orig_bin=ifelse(p_orig>.05, ">.05", "<.05"))

ggplot(dat, aes(x=p_orig, fill=p_orig_bin))+geom_histogram()+scale_fill_viridis(discrete=T)

ggplot(dat, aes(x=subfield, fill=p_orig_bin))+geom_bar(stat="count", position="dodge")+scale_fill_viridis(discrete=T)

ggplot(dat, aes(x=open_data |> factor(), fill=p_orig_bin))+geom_bar(stat="count", position="dodge")+scale_fill_viridis(discrete=T)+facet_wrap(.~str_c("open_mat ",open_mat))

ggplot(dat, aes(x=factor(stanford), fill=p_orig_bin))+geom_bar(stat="count", position="dodge")+scale_fill_viridis(discrete=T)

ggplot(dat, aes(x=factor(change_platform), fill=p_orig_bin))+geom_bar(stat="count", position="dodge")+scale_fill_viridis(discrete=T)

ggplot(dat, aes(x=factor(is_within), fill=p_orig_bin))+geom_bar(stat="count", position="dodge")+scale_fill_viridis(discrete=T)

ggplot(dat, aes(x=factor(single_vignette), fill=p_orig_bin))+geom_bar(stat="count", position="dodge")+scale_fill_viridis(discrete=T)
```

```{r}
# using d for model to get non-z-scored version
dat <- d_for_model |> filter(!is.na(p_orig))

ggplot(dat, aes(x=pub_year, y=p_orig, color=p_orig))+geom_point()+geom_smooth(method="lm")+scale_color_viridis()

ggplot(dat, aes(x=log_ratio_ss, y=log_sample, color=p_orig))+geom_point()+scale_color_viridis()

ggplot(dat, aes(x=log_ratio_ss, y=p_orig, color=p_orig))+geom_point()+geom_smooth(method="lm")+scale_color_viridis()

ggplot(dat, aes(x=log_sample, y=p_orig, color=p_orig))+geom_point()+geom_smooth(method="lm")+scale_color_viridis()

ggplot(dat, aes(x=log_trials, y=p_orig, color=p_orig))+geom_point()+geom_smooth(method="lm")+scale_color_viridis()

```
# Exploratory even randomer

## Model exploration

```{r}
mod <- lm(sub_rep ~ z_pub_year + subfield + open_data + open_mat + 
            stanford + change_platform + 
            z_log_ratio_ss + is_within + 
            single_vignette + z_log_sample + z_log_trials,
          data = data_tier1 )
summary(mod)
```

Repeating regularized

```{r}
predictors <- data_tier1 |> 
  select(z_pub_year, open_data, open_mat, stanford, change_platform, 
         z_log_ratio_ss, is_within, single_vignette, z_log_sample, z_log_trials) |>
  as.data.frame() |>
  as.matrix()

lasso_linear <- cv.glmnet(predictors, data_tier1$sub_rep, 
                          family="gaussian", alpha=1)

coef(lasso_linear, s = "lambda.min")
coef(lasso_linear, s = "lambda.1se")
```

## Principal components

Principal components are not very interpretable. 

```{r}
pcs <- select(data_tier1, 
              z_pub_year, open_data,  open_mat, stanford, change_platform, 
              z_log_ratio_ss, is_within, single_vignette, z_log_sample, z_log_trials) |>
  princomp()

summary(pcs)
pcs$loadings
plot(pcs)
biplot(pcs)
```

## Bayesian tinkering

Let's try super strong priors, consolidating a few very highly correlated variables. 

```{r, eval=F}
normal_priors <- c(set_prior("horseshoe(3)", class="b"),
                   set_prior("normal(0,.5)", class="sd"))

brm(sub_rep ~ z_pub_year + subfield + open_data + open_mat + stanford + change_platform + z_log_ratio_ss + is_within + single_vignette + z_log_sample +  z_log_trials + 
      (1 | academic_year),
    # family = "linear", # runs on 1-5 data
    data = data_tier1,
    prior = normal_priors, 
    iter = 10000, warmup = 2000,
    control = list(adapt_delta=.99),
    backend = "cmdstanr")
```

And let's see if it's the link


```{r, eval=F}
normal_priors <- c(set_prior("horseshoe(3)", class="b"),
                   set_prior("normal(0,.5)", class="sd"))

# make it in the .005 - .995 range
data_tier1$sub_rep01 <- ((data_tier1$sub_rep-1)/5) * .99 + .005


brm(sub_rep01 ~ z_pub_year + subfield + open_data + open_mat + stanford + change_platform + z_log_ratio_ss + is_within + single_vignette + z_log_sample +  z_log_trials + 
      (1 | academic_year),
    family = "beta", # runs on 1-5 data
    data = data_tier1,
    prior = normal_priors, 
    iter = 10000, warmup = 2000,
    control = list(adapt_delta=.99),
    backend = "cmdstanr")
```



## Models of clusters of predictors

```{r}
mod <- lm(sub_rep ~ 
            is_within + 
            single_vignette +  z_log_trials,
          data = data_tier1 )
summary(mod)
```


## other bayesian models

```{r, eval=F}

strong_priors <- c(set_prior("horseshoe(3, par_ratio=.33)", class="b"),
                   set_prior("normal(0,.5)", class="sd"),
                   set_prior("lkj(1)", class="cor"))

tier1_subjective_strong_prior <- brm(sub_rep ~ z_pub_year +
                                       subfield + open_data +  
                                       open_mat + stanford + change_platform + 
                                       z_log_ratio_ss + is_within + 
                                       single_vignette + z_log_sample + 
                                       z_log_trials + 
                                       (z_pub_year + subfield + open_data +  open_mat + stanford + change_platform + 
                                          z_log_ratio_ss + is_within + single_vignette + z_log_sample + z_log_trials | academic_year),
                                     family="cumulative", # runs on 1-5 data
                                     data=data_tier1,
                                     file=here(model_location, "tier1_subjective_prior"),
                                     prior=strong_priors, 
                                     control=list(adapt_delta=.99),
                                     backend="cmdstanr"
)
```

```{r, eval=F}

# bad linear

tier1_subjective_linear<- brm(sub_rep ~ z_pub_year + subfield + open_data +  open_mat + stanford + change_platform + 
                                z_log_ratio_ss + is_within + single_vignette + z_log_sample + z_log_trials + 
                                (z_pub_year + subfield + open_data +  open_mat + stanford + change_platform + 
                                   z_log_ratio_ss + is_within + single_vignette + z_log_sample + z_log_trials | academic_year),
                              # family="cumulative", # runs on 1-5 data
                              data=data_tier1 |> mutate(sub_rep=(sub_rep-1)/4),
                              file=here(model_location, "tier1_subjective_linear"),
                              prior=strong_priors, 
                              control=list(adapt_delta=.99),
                              backend="cmdstanr"
)

tier1_subjective_linear2<- brm(sub_rep ~ z_pub_year + subfield + open_data +  open_mat + stanford + change_platform + 
                                 z_log_ratio_ss + is_within + single_vignette + z_log_sample + z_log_trials + 
                                 (z_pub_year + subfield + open_data +  open_mat + stanford + change_platform + 
                                    z_log_ratio_ss + is_within + single_vignette + z_log_sample + z_log_trials | academic_year),
                               # family="cumulative", # runs on 1-5 data
                               data=data_tier1 |> mutate(sub_rep=(sub_rep-1)/4),
                               file=here(model_location, "tier1_subjective_linear2"),
                               prior=priors, 
                               control=list(adapt_delta=.99),
                               backend="cmdstanr"
)
```

```{r, eval=F}
tier1_subjective_beta<- brm(sub_rep ~ z_pub_year + subfield + open_data +  open_mat + stanford + change_platform + 
                              z_log_ratio_ss + is_within + single_vignette + z_log_sample + z_log_trials + 
                              (z_pub_year + subfield + open_data +  open_mat + stanford + change_platform + 
                                 z_log_ratio_ss + is_within + single_vignette + z_log_sample + z_log_trials | academic_year),
                            family="beta", # runs on 1-5 data
                            data=data_tier1 |> mutate(sub_rep=(sub_rep-1)/4*.98+.01),
                            file=here(model_location, "tier1_subjective_beta"),
                            prior=strong_priors, 
                            control=list(adapt_delta=.99),
                            backend="cmdstanr"
)

```


## TODO predictive

```{r}
# cognitive, within, foobar trials, foobar participants, etc etc 

back_convert

fake_data <- tribble(
   ~subfield, ~open_data, ~open_mat, ~change_platform, ~is_within, ~single_vignette, ~log_sample, ~log_trials,
  "cognitive", 1,         1,         0,                1,          0,                log(50),    log(100),
  "cognitive", 0,         0,         0,                1,          0,                log(50),    log(100),
  "cognitive", 1,         1,         0,                1,          0,                log(50),    log(100),
   "social", 0,         0,         1,                0,          1,                log(30),     log(1),
) |> mutate(academic_year="2022-2023", pub_year=2022, stanford=0, log_ratio_ss=0,
            z_log_sample=(log_sample-back_convert$mean_log_sample)/back_convert$sd_log_sample,
            z_log_trials=(log_trials-back_convert$mean_log_trials)/back_convert$sd_log_trials,
            z_pub_year=(pub_year-back_convert$mean_pub_year)/back_convert$sd_pub_year,
            z_log_ratio_ss=(log_ratio_ss-back_convert$mean_log_ratio_ss)/back_convert$sd_log_ratio_ss, sub_rep=NA) |> mutate(social=ifelse(subfield=="social", 1,0),other_psych=ifelse(subfield=="other-psych",1,0), non_psych=ifelse(subfield=="non-psych", 1,0)) |> 
select(z_pub_year, open_data, open_mat, stanford, change_platform, social, other_psych, non_psych, 
                                   z_log_ratio_ss, is_within, single_vignette, z_log_sample, z_log_trials) |> as.matrix()
blah <- predict(lasso_linear_1, fake_data)           
#foo <- predict(tier1_subjective, newdata=fake_data)

#bar <- fitted(tier1_subjective, newdata=fake_data)
```