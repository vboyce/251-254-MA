---
title: "251 MA"
output:
  html_document: 
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=F, message=F)
knitr::opts_chunk$set(dev = "png", dev.args = list(type = "cairo-png"))
options(knitr.table.format = "html")
knitr::opts_chunk$set(echo = F)
library(tidyverse)
library(viridis)
library(Replicate)
library(metafor)
theme_set(theme_bw())
```

# TODOs
- get ES from t test, from F test (using compute es) < -- what does within_one and within_two mean??
- validate df against num people?
- what about for other test statistics

# Pull data

```{r, eval=F}
library(googledrive)

f <- googledrive::as_dribble("https://docs.google.com/spreadsheets/d/1UT6KLRujn6iEQ_s01_4yNfFYqc7hAWTpB-t9mdDp0O8/edit#gid=0")
googledrive::drive_download(f, path="raw_data.xlsx", overwrite=T)

```

```{r}
d <- readxl::read_xlsx("raw_data.xlsx", sheet="aligned data", skip=2) |> 
  select(target_lastauthor_year, status, academic_year, subfield, target_year, stanford_internal, 
         open_data, open_materials, target_on_turk, replication_on_turk, 
         within_between, single_vignette, repeated_measure,
         target_N, target_test, target_raw_stat, target_pvalue, target_ES_type, target_ES_value,
         replication_N, replication_test, replication_raw_stat, replication_pvalue, replication_ES_type, replication_ES_value,
         replicated_instructor_code, replicated_report_code)

```

# Exclusions

```{r}
d |> group_by(status) |> tally()
```
# Validation

```{r}
d_val <- d |> filter(!status %in% c("missing", "non-experiment", "reproduction"))

d_val$academic_year |> unique()

d_val |> filter(!subfield %in% c("social","cognitive","non-psych","other-psych"))

d_val |> filter(!stanford_internal %in% c("no","yes"))

d_val |> filter(!open_data %in% c("no","yes"))

d_val |> filter(!open_materials %in% c("no","yes"))

d_val |> filter(!target_on_turk %in% c("no","yes"))

d_val |> filter(!replication_on_turk %in% c("no","yes"))

d_val |> filter(!within_between %in% c("within","between","mixed"))

d_val |> filter(!single_vignette %in% c(0,1))





```
# Parsing
```{r}
test <- "t(42)=2.41"
ftest <- "F(1,12)=45.43"
parse_t <- function(tval) {
  df=str_extract(tval, "\\(.*\\)") |> str_sub(2,-2) |> as.numeric()
  val=str_extract(tval, "=.*") |> str_sub(2,-1) |> as.numeric() |> abs()
  return(data.frame("df_2"=df,"tstat"=val))
}

parse_f <- function(fval){
  df_1 =str_extract(fval, "\\(.*,") |> str_sub(2,-2) |> as.numeric()
  df_2 =str_extract(fval, ",.*\\)") |> str_sub(2,-2) |> as.numeric()
  val=str_extract(fval, "=.*") |> str_sub(2,-1) |> as.numeric() |> abs()
  return(data.frame("df_1"=df_1,"df_2"=df_2,"fstat"=val))
}



p_from_t <- function(d) {
  pt(q=d$tstat, df=d$df_2, lower.tail=FALSE)*2 # two tailed
}

p_from_f <- function(d) {
  pf(q=d$fstat, df1=d$df_1, df2=d$df_2, lower.tail=FALSE)
}

parse_t(test) |> p_from_t()
parse_f(ftest) |> p_from_f()

```

```{r}
test <-  d_val |> 
  mutate(target_p_calc=case_when(
    str_sub(target_raw_stat,1,1)=="t" ~ parse_t(target_raw_stat) |> p_from_t(),
    str_sub(target_raw_stat,1,1)=="F" ~ parse_f(target_raw_stat) |> p_from_f()),
    rep_p_calc=case_when(
    str_sub(replication_raw_stat,1,1)=="t" ~parse_t(replication_raw_stat) %>% p_from_t(),
    str_sub(replication_raw_stat,1,1)=="F" ~parse_f(replication_raw_stat) |> p_from_f()))

ggplot(test, aes(x=target_pvalue, y=target_p_calc))+geom_point()+geom_abline(slope=1,intercept=0)+
  scale_x_log10()+scale_y_log10()

ggplot(test, aes(x=replication_pvalue, y=rep_p_calc))+geom_point()+geom_abline(slope=1,intercept=0)+scale_x_log10()+scale_y_log10()

```

# How much missing data?

```{r, message=T}
message("total rows")
d |> filter(!status %in% c("missing", "non-experiment", "reproduction")) |> nrow()

message("number of NAs per column")

d |> filter(!status %in% c("missing", "non-experiment", "reproduction")) |> summarize(                                                      across(everything(),~sum(is.na(.)))) |>
pivot_longer(everything()) |> 
  arrange(desc(value)) |> 
  filter(value!=0)
  

```

# Correlation between replication scores


```{r, message=T}
d_corr <- d |> filter(!status %in% c("missing", "non-experiment", "reproduction")) |> 
  mutate(replicated_instructor_code=as.numeric(replicated_instructor_code)) |> #forcibly convert the ?s to NAs
  filter(!is.na(replicated_instructor_code) & !is.na(replicated_report_code))

corr <- cor.test(d_corr$replicated_instructor_code, d_corr$replicated_report_code, method = 'spearman')

message("Num not match")
d_corr |> filter(replicated_instructor_code!=replicated_report_code) |> nrow()

message("Num match")
d_corr |> filter(replicated_instructor_code==replicated_report_code) |> nrow()

message("distribution of non-matches")

ggplot(d_corr |> filter(replicated_instructor_code!=replicated_report_code), aes(x=replicated_instructor_code, y=replicated_report_code))+geom_jitter(width=.04, height=.04)+theme_bw()

d_corr |>
  group_by(replicated_instructor_code, replicated_report_code ) |> tally() |> arrange(replicated_report_code) |> 
  pivot_wider(names_from=replicated_report_code, values_from=n, values_fill=0)
```


# Are the ES's okay?

```{r}
library(metafor)

fill_es <- function(type, value, n){
  if (is.na(type)) {
    return(NA)}
  if (is.na(value)) {
    return(NA)
  }
  if (type=="partial eta sq"){
    d = sqrt( (n-1)/n * abs(value)/(1-abs(value)))
    if (value < 0) {
      return(-d)}
    return(d)
    }
  if (type %in% c("d", "SMD")){
    return(value)
  }
  return(NA)
}

est_SE <- function(p,d){
  z <- -.862+sqrt(abs(.743-2.404*log(p)))
  SE <- abs(d/z)
  return(SE)
}

d_es <-  d |> filter(!status %in% c("missing", "non-experiment", "reproduction")) |> 
  rowwise() |> 
  mutate(d_calc_target=fill_es(target_ES_type, target_ES_value, target_N),
         se_calc_target=est_SE(target_pvalue,d_calc_target),
         d_calc_rep=fill_es(replication_ES_type, replication_ES_value, replication_N),
         se_calc_rep=est_SE(replication_pvalue,d_calc_rep))

```

```{r}

d_es_try <- d_es |> filter(!is.na(d_calc_target)) |> 
  filter(!is.na(d_calc_rep)) |> 
  mutate(
         predInt=Replicate::pred_int(d_calc_target,se_calc_target**2, d_calc_rep, se_calc_rep**2)$rep.inside,
         p_orig=Replicate::p_orig(d_calc_target,se_calc_target**2, d_calc_rep, t2=0, se_calc_rep**2))
  
```

# PredInt and P_orig

```{r}

d_es_try |> ggplot(aes(x=d_calc_target, y=d_calc_rep, color=p_orig))+
  geom_point()+
  coord_cartesian(xlim=c(0,2), ylim=c(-1,3))+
  geom_abline(slope=1, intercept=0)+
  geom_hline(yintercept=0)+
  scale_color_viridis(discrete=F, direction=-1)+
  labs(color="p_orig", x="Original SMD", y="Replication SMD")

d_es_try |> mutate(p_sig=p_orig<.05) |> ggplot(aes(x=d_calc_target, y=d_calc_rep, color=p_sig))+
  geom_point()+
  coord_cartesian(xlim=c(0,2), ylim=c(-1,3))+
  geom_abline(slope=1, intercept=0)+
  geom_hline(yintercept=0)+
  scale_color_viridis(discrete=T, direction=-1)+
  labs(color="P_orig<.05", x="Original SMD", y="Replication SMD")

d_es_try |> ggplot(aes(x=d_calc_target, y=d_calc_rep, color=predInt))+
  geom_point()+
  coord_cartesian(xlim=c(0,2), ylim=c(-1,3))+
  geom_abline(slope=1, intercept=0)+
  geom_hline(yintercept=0)+
  scale_color_viridis(discrete=T, direction=-1)+
  labs(color="rep in predInt", x="Original SMD", y="Replication SMD")

d_es_try |> ggplot(aes(x=replicated_report_code, y=p_orig))+geom_jitter(height=0, alpha=.5)+
  #scale_y_log10()+
  geom_hline(yintercept=.05)

d_es_try |> ggplot(aes(x=replicated_report_code, y=predInt))+geom_jitter(alpha=.5)
```


# Prelim analysis -- Correlation between ES

There's that one ling paper with ES of 10+...

Might want to just hide that point or something instead...

Could weight by precision or something

```{r}
  
d_es |> ggplot(aes(x=d_calc_target, y=d_calc_rep, color=as.factor(replicated_report_code)))+
  geom_point()+
  #coord_cartesian(xlim=c(0,5), ylim=c(-1,5))+
  geom_abline(slope=1, intercept=0)+
  scale_color_viridis(discrete=T, direction=-1)

d_es |> ggplot(aes(x=d_calc_target, y=d_calc_rep, color=as.factor(replicated_report_code)))+
  geom_point()+
  coord_cartesian(xlim=c(0,2), ylim=c(-1,3))+
  geom_abline(slope=1, intercept=0)+
  geom_hline(yintercept=0)+
  scale_color_viridis(discrete=T, direction=-1)+
  labs(color="Replicated?", x="Original SMD", y="Replication SMD")
```

# code vars for models

NOTE: will need to replace replicated_code with the discussion agreed one!!

## demographics


```{r}
d_demo <- d_es |> 
  ungroup() |> 
  mutate(pub_year= target_year-mean(target_year)) |> 
  select(target_year, pub_year, subfield, replicated_report_code, academic_year)

summary(d_demo)
d_demo |> group_by(subfield) |> tally()
```

## statistics

? will outliers on ratio_ss cause a problem?

```{r}
d_stats <- d_es |> 
  mutate(log_p =log(target_pvalue),
         log_sample =log(target_N),
         ratio_ss = replication_N/target_N,
         change_platform=ifelse(replication_on_turk==target_on_turk,0,1)) |> 
  #this codes 1 if the original was in person, but replication turk/prolific,
  # 0 if they were both on turk/prolific or both in-person (rare, but happens a few times)
  select(replicated_report_code,log_p,log_sample, ratio_ss, change_platform, academic_year, d_calc_target)

summary(d_stats)
```

## closeness

```{r}

# could do with mutate across, but clearer this way?

d_close <- d_es |> 
  mutate(open_data=ifelse(open_data=="yes", 1,0),
         open_mat=ifelse(open_materials=="yes", 1,0),
         stanford=ifelse(stanford_internal=="yes", 1,0)) |> 
  select(open_data, open_mat, stanford, replicated_report_code,
         academic_year)

summary(d_close)
```

## design


```{r}
d_design <- d_es |> 
  mutate(is_within=case_when(
    within_between=="within" ~ 1,
    within_between=="mixed" ~ 1,
    within_between=="between" ~ 0),
    log_trials=log(repeated_measure),
    log_sample=log(target_N))|> 
  select(is_within, single_vignette,log_trials, log_sample, replicated_report_code, academic_year)

summary(d_design)
```